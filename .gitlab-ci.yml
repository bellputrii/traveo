default:
  image: node:20-alpine

stages:
  - install
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  # Hapus NODE_ENV=production biar devDependencies ikut ter-install
  # VERCEL_ORG_ID dan VERCEL_PROJECT_ID ambil dari CI/CD variables di GitLab

.base_rules: &base_rules
  only:
    - main

Install:
  <<: *base_rules
  stage: install
  script:
    # install semua dependencies termasuk devDependencies (typescript, eslint, dll.)
    - npm ci --include=dev --cache .npm --prefer-offline --progress=false --no-audit
  cache:
    paths:
      - .npm/
  artifacts:
    paths:
      - node_modules/
    expire_in: 1h

Build:
  <<: *base_rules
  stage: build
  needs:
    - job: Install
      artifacts: true
  script:
    - npm run build
  artifacts:
    paths:
      - .next/
      - node_modules/
    expire_in: 1h


Deploy:
  <<: *base_rules
  stage: deploy
  needs:
    - Build
  environment:
    name: production
  script:
    - npm install -g vercel
    - vercel deploy --prod --yes --token $VERCEL_TOKEN \
      --project-id $VERCEL_PROJECT_ID \
      --org-id $VERCEL_ORG_ID